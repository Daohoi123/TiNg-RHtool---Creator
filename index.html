<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TiNg RHtool Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://res.cloudinary.com/dzfuqyqoq/image/upload/v1760603391/hinh_nen_ea6eul.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        /* Custom shadow styles for a sharper, darker look */
        .sharp-shadow-lg {
            box-shadow: 0 14px 34px -7px rgba(0, 0, 0, 0.5), 0 11px 14px -8px rgba(0, 0, 0, 0.5);
        }
        .sharp-shadow-md {
            box-shadow: 0 5px 11px 0 rgba(0, 0, 0, 0.5);
        }
        /* Remove default blue outline on focus for inputs and select */
        input:focus, select:focus {
            outline: none;
            box-shadow: none;
        }
        /* Custom styling for the select dropdown arrow */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23005073%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 0.8em auto;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-6">

    <div class="w-full max-w-xl mx-auto text-center">
        <!-- Logo -->
        <img src="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1760352074/logo_TiNg_qobnrt.png" alt="Logo" class="w-32 h-auto mx-auto mb-6">

        <!-- Title -->
        <h1 class="text-5xl font-bold text-[rgb(0,80,115)]">TiNg RHtool Generator</h1>
        <p class="text-[rgb(0,80,115)] mt-3 text-xl">Create your personalized AI image tool</p>

        <!-- Main Content Box -->
        <div class="w-full bg-white sharp-shadow-lg pt-8 pb-8 px-12 md:pt-8 md:pb-4 md:px-12 mt-10 text-left">
            <div class="space-y-8">
                <!-- API Key Input -->
                <div>
                    <label for="api-key" class="block text-base font-medium text-gray-700 mb-3">API Key</label>
                    <div class="flex items-center bg-white border border-black sharp-shadow-md">
                        <div class="p-4">
                            <!-- Key Icon SVG -->
                            <svg class="w-8 h-8 text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z" />
                            </svg>
                        </div>
                        <div class="border-l border-black h-10"></div>
                        <input type="text" id="api-key" placeholder="Enter your API key here" class="w-full p-4 bg-transparent text-black placeholder-gray-500 focus:outline-none text-lg">
                    </div>
                </div>

                <!-- Language Selection -->
                <div>
                    <label for="language" class="block text-base font-medium text-gray-700 mb-3">Language</label>
                     <div class="flex items-center bg-white border border-black sharp-shadow-md">
                        <div class="p-4">
                            <!-- New Globe Icon SVG -->
                           <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-black" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18Z" />
                              <path stroke-linecap="round" stroke-linejoin="round" d="M3.51 9h16.98" />
                              <path stroke-linecap="round" stroke-linejoin="round" d="M3.51 15h16.98" />
                              <path d="M12 2.05c1.886 2.39 3 5.42 3 9.95s-1.114 7.56-3 9.95" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M12 2.05C10.114 4.44 9 7.47 9 12s1.114 7.56 3 9.95" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="border-l border-black h-10"></div>
                         <select id="language" class="w-full p-4 bg-transparent text-black focus:outline-none cursor-pointer text-lg">
                            <option value="vi">Tiếng Việt (Vietnamese)</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Generate Button -->
            <button id="generate-btn" class="w-full bg-[rgb(0,80,115)] hover:bg-[rgb(0,65,95)] text-white font-bold py-4 px-4 rounded-full transition duration-300 ease-in-out mt-12 text-lg">
                Generate & Download Tool
            </button>
            <p id="error-message" class="text-red-500 text-center text-base h-6 mt-6"></p>
        </div>
    </div>


<script>
// The full HTML content of the tool is stored in this template literal.
const baseHtmlTemplate = `
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Image</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759916322/logo_tzk6ft.png">
    <link rel="apple-touch-icon" href="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1758271750/logo_dia1pb.png">
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://res.cloudinary.com/dzfuqyqoq/image/upload/v1758006412/nen_ephcrp.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed; /* Giữ nền cố định khi cuộn */
        }
        
        /* Giao diện loading GIF */
        .loading-gif {
            width: 150px; /* Thu nhỏ GIF loading trên mobile */
            height: 150px;
            mix-blend-mode: screen;
        }

        @media (min-width: 1024px) {
            .loading-gif {
                width: 200px;
                height: 200px;
            }
        }

        /* Thanh cuộn tùy chỉnh */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        #prompt-input::placeholder { color: #a0aec0; }
        .drop-zone-active {
            outline: 2px dashed #4299e1;
            outline-offset: -4px;
            background-color: rgba(66, 153, 225, 0.1);
        }
        
        /* Hiệu ứng hover cho các nút chức năng trên ảnh */
        .corner-hotspot {
            position: absolute;
            z-index: 25;
            padding: 1rem;
        }
        .hover-btn {
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            pointer-events: none;
            white-space: nowrap;
        }
        .animate-from-left { transform: translateX(-15px); }
        .animate-from-right { transform: translateX(15px); }
        .corner-hotspot:hover .hover-btn, .touch .corner-hotspot .hover-btn { /* Hiển thị nút trên thiết bị cảm ứng */
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        /* Giao diện so sánh ảnh */
        .preview-container { cursor: grab; }
        .preview-container.grabbing { cursor: grabbing; }
        #image-compare-container, #preview-compare-container { display: none; }
        #history-panel { transition: transform 0.3s ease-in-out; }
        
        /* Giao diện mới */
        .nav-item {
            padding: 12px;
            border-radius: 12px;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .nav-item.active {
            background-color: #2D3E50; /* Xanh xám đậm */
        }
        .nav-item.active img {
            transform: scale(1.15);
        }
        .nav-item img {
            transition: transform 0.2s ease-in-out;
        }
        .control-section {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .control-select, .control-textarea {
            background-color: #2D3E50;
            color: white;
            border: none;
            border-radius: 8px;
        }
        .control-textarea::placeholder {
            color: #a0aec0;
        }
    </style>
</head>
<body class="text-white">

    <div class="w-full max-w-7xl mx-auto flex flex-col lg:flex-row gap-4 p-4 min-h-screen lg:h-screen lg:py-4">
        
        <!-- Thanh điều hướng: ngang trên mobile, dọc bên trái trên desktop -->
        <nav class="flex flex-row lg:flex-col items-center justify-center lg:justify-start gap-4 bg-[#1C2A3A] p-2 lg:p-4 rounded-2xl shadow-lg w-full lg:w-auto">
            <button id="nav-qwen" class="nav-item active">
                <img src="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759051851/logo_Qwen_qezdmm.png" alt="Qwen" class="w-12 h-12 lg:w-[70px] lg:h-auto object-contain">
            </button>
            <button id="nav-advanced" class="nav-item">
                <img src="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1758007927/nang_cao_k6yhkj.png" alt="Nâng Cao" class="w-12 h-12 lg:w-[70px] lg:h-auto object-contain">
            </button>
            <button id="nav-basic" class="nav-item">
                <img src="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1758007927/co_ban_hgoegq.png" alt="Cơ Bản" class="w-12 h-12 lg:w-[70px] lg:h-auto object-contain">
            </button>
            <button id="nav-history" class="nav-item">
                <img src="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1758007927/lich_su_tkh4qi.png" alt="Lịch Sử" class="w-12 h-12 lg:w-[70px] lg:h-auto object-contain">
            </button>
        </nav>

        <!-- Bảng điều khiển chức năng -->
        <div class="w-full lg:w-1/3 lg:max-w-xs flex flex-col gap-4">
             <!-- Chức năng & Mô hình -->
            <div id="controls-container" class="control-section text-gray-800 flex-grow">
                 <!-- Qwen Controls (Moved here) -->
                <div id="qwen-options-container" class="hidden flex-col space-y-4">
                    <div id="aspect-ratio-container">
                        <label for="aspect-ratio" class="block text-sm font-medium mb-2">Khung hình</label>
                        <select id="aspect-ratio" class="w-full p-3 focus:ring-2 focus:ring-blue-500 control-select">
                            <option value="0">1:1</option>
                            <option value="1">3:4</option>
                            <option value="2">4:3</option>
                            <option value="3">9:16</option>
                            <option value="4">16:9</option>
                        </select>
                    </div>
                    <div class="flex items-center">
                        <input id="keep-layout-checkbox" type="checkbox" class="h-4 w-4 rounded text-blue-600 focus:ring-blue-500 border-gray-500">
                        <label for="keep-layout-checkbox" class="ml-2 block text-sm">Giữ bố cục và đối tượng</label>
                    </div>
                    <div id="qwen-ref-container" class="flex-col space-y-2 pt-2">
                        <label class="block text-sm font-medium">Ảnh tham chiếu</label>
                        <div id="qwen-ref-drop-zone" tabindex="0" class="relative w-full aspect-square border-2 border-dashed border-gray-400 rounded-lg flex items-center justify-center text-gray-500 hover:border-blue-500 transition-colors cursor-pointer focus:outline-none">
                            <div id="qwen-ref-upload-prompt" class="text-center pointer-events-none">
                                 <p class="mt-1 text-xs">Nhấn, kéo thả hoặc dán ảnh</p>
                            </div>
                            <img id="qwen-ref-preview" class="absolute hidden w-full h-full object-cover rounded-lg">
                            <button id="remove-qwen-ref-btn" class="absolute -top-2 -right-2 bg-red-600 rounded-full h-5 w-5 flex items-center justify-center text-white text-xs font-bold hidden z-10">&times;</button>
                        </div>
                        <input type="file" id="qwen-ref-file-input" class="hidden" accept="image/*">
                    </div>
                    <div class="mt-4">
                        <img src="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759569593/qwen-01_a89k6p.jpg" alt="Minh họa Qwen" class="w-full h-auto rounded-lg shadow-md">
                    </div>
                </div>

                 <!-- Basic Controls -->
                <div id="controls-basic" class="hidden flex-col space-y-4">
                    <div>
                        <label for="processing-mode" class="block text-sm font-medium mb-2">Chức năng</label>
                        <select id="processing-mode" class="w-full p-3 focus:ring-2 focus:ring-blue-500 control-select">
                            <option value="removebg">Tách nền</option>
                            <option value="mask">Tách nền lấy mask</option>
                            <option value="upscale">Tăng độ phân giải</option>
                        </select>
                    </div>
                    <div id="upscale-controls-basic" style="display: none;">
                        <label for="upscale-level" class="block text-sm font-medium mb-2">Mức độ</label>
                        <select id="upscale-level" class="w-full p-3 focus:ring-2 focus:ring-blue-500 control-select">
                            <option value="1" selected>x2</option>
                            <option value="2">x4</option>
                        </select>
                    </div>
                </div>
                
                <!-- Advanced Controls -->
                <div id="controls-advanced" class="hidden flex-col space-y-4 h-full">
                     <div class="flex-grow overflow-y-auto pr-2 space-y-4 max-h-[60vh] lg:max-h-full">
                        <div>
                            <label for="processing-mode-advanced" class="block text-sm font-medium mb-2">Chức năng</label>
                            <select id="processing-mode-advanced" class="w-full p-3 focus:ring-2 focus:ring-blue-500 control-select">
                                <option value="flux_upscale" selected>Flux Upscale</option>
                                <option value="change_bg">Thay nền</option>
                                <option value="ge_2">Khôi phục ảnh củ</option>
                                <option value="ge_3">Làm nét ảnh mờ (deblur)</option>
                                <option value="id_photo">Tạo ảnh thẻ</option>
                                <option value="face_swap">Thay thế khuôn mặt</option>
                                <option value="ecommerce_process">E-commerce</option>
                                <option value="ge_7">Xóa vật theo yêu cầu</option>
                                <option value="ge_22">Xóa mụn, mịn da</option>
                                <option value="ge_4">Chỉnh ảnh (trang điểm, làm sáng)</option>
                                <option value="ge_8">Hòa trộn đồng bộ ánh sáng</option>
                                <option value="light_shadow">Light and Shadow</option>
                                <option value="ge_9">Phục hồi sản phẩm</option>
                                <option value="ge_10">Thay trang phục</option>
                                <option value="ge_14">Tách trang phục</option>
                                <option value="ge_15">Trích xuất hình ảnh</option>
                                <!-- START NEW OPTION -->
                                <option value="render_architecture">Render kiến trúc</option>
                                <!-- END NEW OPTION -->
                                <option value="ge_17">Phong cách ảnh vector</option>
                                <option value="ge_11">Ảnh hoạt hình Ghibli</option>
                                <option value="ge_18">Ảnh 3D chibi</option>
                                <option value="ge_19">Ảnh màu nước</option>
                                <option value="ge_20">Ảnh vẽ tay (phong cách Trung Hoa)</option>
                                <option value="ge_13">Tranh biến họa (bút chì)</option>
                                <option value="ge_12">Ảnh phát thảo ánh sáng</option>
                                <option value="ge_30">Fridge Magnets Style</option>
                            </select>
                        </div>
                        <div id="function-preview-container" class="mt-4 hidden">
                            <img id="function-preview-image" src="" alt="Minh họa chức năng" class="w-full h-auto rounded-lg shadow-md">
                        </div>
                        <div id="flux-upscale-controls" class="hidden flex-col space-y-4">
                            <label for="flux-upscale-model" class="block text-sm font-medium mb-2">Mô hình</label>
                            <select id="flux-upscale-model" class="w-full p-3 focus:ring-2 focus:ring-blue-500 control-select">
                                <option value="seedvr2" selected>SeedVR2</option>
                                <option value="realesrgan">RealESRGAN</option>
                            </select>
                            <div class="text-base text-gray-600 p-2 bg-gray-100 rounded-md space-y-1">
                                <p><span class="font-semibold">RealESRGAN:</span> thời gian tạo ảnh nhanh nhưng không giữ được nét mặt.</p>
                                <p><span class="font-semibold">SeedVR2:</span> tạo ảnh chuyên sâu, kết quả tốt hơn và khuôn mặt có độ giống cao hơn nhưng thời gian tạo ảnh lâu.</p>
                                <p class="mt-1 pt-1 border-t border-gray-200"><span class="font-semibold">Gợi ý:</span> Nếu ảnh quá mờ hoặc có người thì dùng SeedVR2, còn ảnh thông thường dùng RealESRGAN để tạo ảnh nhanh hơn.</p>
                            </div>
                        </div>
                         <!-- START: E-commerce Controls -->
                        <div id="ecommerce-controls" class="hidden flex-col space-y-2">
                            <label class="block text-sm font-medium">Hiệu ứng</label>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <img id="effect-shadow" src="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759571791/hinh-02_oz1utb.jpg" alt="Bóng đổ" class="w-full h-auto rounded-lg cursor-pointer border-4 border-blue-500 transition-all">
                                    <p class="text-center text-xs mt-1 font-medium">Bóng đổ</p>
                                </div>
                                <div>
                                    <img id="effect-mirror" src="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759571797/hinh-03_qrfv5k.jpg" alt="Hiệu ứng gương" class="w-full h-auto rounded-lg cursor-pointer border-4 border-transparent transition-all">
                                    <p class="text-center text-xs mt-1 font-medium">Hiệu ứng gương</p>
                                </div>
                            </div>
                        </div>
                        <!-- END: E-commerce Controls -->
                        <div id="change-bg-controls" class="hidden flex-col space-y-2">
                            <label class="block text-sm font-medium">Background tham chiếu</label>
                            <div id="ref-bg-drop-zone" tabindex="0" class="relative w-full aspect-square border-2 border-dashed border-gray-400 rounded-lg flex items-center justify-center text-gray-500 hover:border-blue-500 transition-colors cursor-pointer focus:outline-none">
                                <div id="ref-bg-upload-prompt" class="text-center pointer-events-none">
                                     <p class="mt-1 text-xs">Nhấn, kéo thả hoặc dán ảnh</p>
                                </div>
                                <img id="ref-bg-preview" class="absolute hidden w-full h-full object-cover rounded-lg">
                                <button id="remove-ref-bg-btn" class="absolute -top-2 -right-2 bg-red-600 rounded-full h-5 w-5 flex items-center justify-center text-white text-xs font-bold hidden z-10">&times;</button>
                            </div>
                            <input type="file" id="ref-bg-file-input" class="hidden" accept="image/*">
                        </div>
                        <div id="ge-2-controls" class="hidden flex-col space-y-2">
                            <div class="flex items-center mt-2">
                                <input id="less-impact-checkbox" type="checkbox" class="h-4 w-4 rounded text-blue-600 focus:ring-blue-500 border-gray-500">
                                <label for="less-impact-checkbox" class="ml-2 block text-sm">Ít tác động</label>
                            </div>
                        </div>
                        <div id="ge-8-controls" class="hidden flex-col space-y-2">
                            <div class="flex items-center mt-2">
                                <input id="strong-effect-checkbox" type="checkbox" class="h-4 w-4 rounded text-blue-600 focus:ring-blue-500 border-gray-500">
                                <label for="strong-effect-checkbox" class="ml-2 block text-sm">Tác động mạnh</label>
                            </div>
                        </div>
                        <div id="ge-10-controls" class="hidden flex-col space-y-2">
                            <label class="block text-sm font-medium">Ảnh trang phục</label>
                            <div id="clothing-img-drop-zone" tabindex="0" class="relative w-full aspect-square border-2 border-dashed border-gray-400 rounded-lg flex items-center justify-center text-gray-500 hover:border-blue-500 transition-colors cursor-pointer focus:outline-none">
                                <div id="clothing-img-upload-prompt" class="text-center pointer-events-none">
                                     <p class="mt-1 text-xs">Nhấn, kéo thả hoặc dán ảnh</p>
                                </div>
                                <img id="clothing-img-preview" class="absolute hidden w-full h-full object-cover rounded-lg">
                                <button id="remove-clothing-img-btn" class="absolute -top-2 -right-2 bg-red-600 rounded-full h-5 w-5 flex items-center justify-center text-white text-xs font-bold hidden z-10">&times;</button>
                            </div>
                            <input type="file" id="clothing-img-file-input" class="hidden" accept="image/*">
                        </div>
                         <!-- START: Face Swap Controls -->
                        <div id="face-swap-controls" class="hidden flex-col space-y-2">
                            <label class="block text-sm font-medium">Khuôn mặt cần thay thế</label>
                            <div id="face-swap-drop-zone" tabindex="0" class="relative w-full aspect-square border-2 border-dashed border-gray-400 rounded-lg flex items-center justify-center text-gray-500 hover:border-blue-500 transition-colors cursor-pointer focus:outline-none">
                                <div id="face-swap-upload-prompt" class="text-center pointer-events-none">
                                     <p class="mt-1 text-xs">Nhấn, kéo thả hoặc dán ảnh</p>
                                </div>
                                <img id="face-swap-preview" class="absolute hidden w-full h-full object-cover rounded-lg">
                                <button id="remove-face-swap-btn" class="absolute -top-2 -right-2 bg-red-600 rounded-full h-5 w-5 flex items-center justify-center text-white text-xs font-bold hidden z-10">&times;</button>
                            </div>
                            <input type="file" id="face-swap-file-input" class="hidden" accept="image/*">
                        </div>
                        <!-- END: Face Swap Controls -->
                     </div>
                </div>
            </div>
        </div>

        <!-- Panel chính: Hiển thị ảnh & Chat -->
        <div class="flex-1 flex flex-col bg-transparent gap-4 min-h-0">
            <!-- Khu vực hiển thị ảnh -->
            <div id="display-area" class="flex-1 flex items-center justify-center rounded-2xl p-2 relative overflow-hidden min-h-[50vh] lg:min-h-0" style="background-image: url('https://res.cloudinary.com/dzfuqyqoq/image/upload/v1758008305/nen_gif_wcbayk.gif'); background-size: cover; background-position: center;">
                <img id="fallback-image" src="https://placehold.co/1024x1024/ffffff/ffffff" alt="Vùng hiển thị kết quả" class="max-w-full max-h-full object-contain opacity-0">
                
                <div id="image-compare-container" class="absolute inset-0 w-full h-full">
                    <img id="original-image-display" src="" alt="Ảnh gốc" class="absolute inset-0 w-full h-full object-contain select-none">
                    <img id="result-image" src="" alt="Ảnh kết quả" class="absolute inset-0 w-full h-full object-contain select-none">
                    <div id="slider-handle" class="absolute top-0 bottom-0 -ml-4 w-8 h-full cursor-ew-resize z-10" style="left: 50%; display: none;">
                        <div class="relative w-full h-full">
                            <div id="slider-icon" class="absolute w-8 h-8 bg-black bg-opacity-60 rounded-full flex items-center justify-center text-white opacity-0 transition-opacity pointer-events-none">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18m-4 4l4-4m0 0l-4-4"></path></svg>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="corner-hotspot top-0 right-0"> <div id="preview-btn" class="hover-btn animate-from-right">Preview</div> </div>
                <div class="corner-hotspot bottom-0 left-0"> <div id="use-original-btn" class="hover-btn animate-from-left">Sử dụng ảnh gốc</div> </div>
                <div class="corner-hotspot bottom-0 right-0 flex flex-col items-end space-y-2">
                    <div id="use-result-btn" class="hover-btn animate-from-right">Sử dụng ảnh</div>
                    <div id="download-btn" class="hover-btn animate-from-right">Tải xuống</div>
                </div>

                <div id="status-overlay" class="absolute inset-0 hidden z-30">
                    <img id="loading-bg-image" src="" class="absolute inset-0 w-full h-full object-cover">
                    <div id="loading-overlay-color" class="absolute inset-0"></div>
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-center px-4">
                        <img src="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1755349021/loading_ok_kdesfk.gif" alt="Đang xử lý..." class="loading-gif">
                        <p id="status-message" class="text-lg text-white font-bold mt-4"></p>
                        <p id="error-message" class="text-red-400 mt-2 font-semibold"></p>
                    </div>
                    <div class="absolute bottom-4 right-4 group">
                        <button id="cancel-btn" class="bg-red-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg transform transition-all hover:scale-110 focus:outline-none opacity-0 group-hover:opacity-100" title="Hủy tác vụ">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Khu vực nhập prompt -->
            <div id="prompt-container" class="bg-white rounded-2xl p-2 flex items-center space-x-3 shadow-lg">
                <label for="file-input" class="cursor-pointer p-2 rounded-full bg-[#E5F5FF] hover:bg-blue-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6" /></svg>
                </label>
                <input type="file" id="file-input" accept="image/*" class="hidden">
                
                <div id="image-preview-container" class="relative hidden">
                    <img id="image-preview" class="h-12 w-12 object-cover rounded-md">
                    <button id="remove-image-btn" class="absolute -top-1 -right-1 bg-red-600 rounded-full h-5 w-5 flex items-center justify-center text-white text-xs font-bold">&times;</button>
                </div>

                <input type="text" id="prompt-input" class="flex-1 bg-transparent text-gray-800 placeholder-gray-500 focus:outline-none" placeholder="Nhập prompt của bạn...">
                
                <button id="send-btn" class="bg-blue-600 hover:bg-blue-700 rounded-lg p-3 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Fullscreen Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50 overflow-hidden">
         <div id="preview-compare-container" class="absolute inset-0 w-full h-full cursor-grab preview-container">
            <div id="preview-transform-wrapper" class="absolute" style="transform-origin: 0px 0px;">
                <img id="preview-original-image" src="" alt="Ảnh gốc xem trước" class="absolute max-w-none max-h-none select-none">
                <img id="preview-result-image" src="" alt="Ảnh kết quả xem trước" class="absolute max-w-none max-h-none select-none">
                <div id="preview-slider-handle" class="absolute top-0 bottom-0 -ml-4 w-8 h-full cursor-ew-resize z-10" style="left: 50%; display: none;">
                    <div class="relative w-full h-full">
                        <div id="preview-slider-icon" class="absolute w-8 h-8 bg-black bg-opacity-60 rounded-full flex items-center justify-center text-white opacity-0 transition-opacity pointer-events-none">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18m-4 4l4-4m0 0l-4-4"></path></svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button id="close-preview-btn" class="absolute top-4 right-4 text-white text-4xl font-bold hover:text-gray-400 transition z-20">&times;</button>
    </div>

    <!-- History Panel -->
    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-40">
        <div id="history-panel" class="absolute top-0 right-0 h-full w-full max-w-md sm:max-w-sm bg-gray-900 shadow-lg p-6 transform translate-x-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Lịch sử ảnh</h2>
                <button id="close-history-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div id="history-grid" class="grid grid-cols-3 gap-4 overflow-y-auto h-[calc(100%-4rem)]">
                <!-- History images will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // --- DOM ELEMENTS ---
        const displayArea = document.getElementById('display-area');
        const fallbackImage = document.getElementById('fallback-image');
        const imageCompareContainer = document.getElementById('image-compare-container');
        const originalImageDisplay = document.getElementById('original-image-display');
        const resultImage = document.getElementById('result-image');
        const sliderHandle = document.getElementById('slider-handle');
        const sliderIcon = document.getElementById('slider-icon');
        
        const statusOverlay = document.getElementById('status-overlay');
        const statusMessage = document.getElementById('status-message');
        const errorMessage = document.getElementById('error-message');
        const loadingBgImage = document.getElementById('loading-bg-image');
        const loadingOverlayColor = document.getElementById('loading-overlay-color');
        const cancelBtn = document.getElementById('cancel-btn'); 
        
        const promptContainer = document.getElementById('prompt-container');
        const fileInput = document.getElementById('file-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const promptInput = document.getElementById('prompt-input');
        const sendBtn = document.getElementById('send-btn');
        const processingModeSelect = document.getElementById('processing-mode');
        const processingModeSelectAdvanced = document.getElementById('processing-mode-advanced');
        const aspectRatioContainer = document.getElementById('aspect-ratio-container');
        const aspectRatioSelect = document.getElementById('aspect-ratio');
        const upscaleControlsBasic = document.getElementById('upscale-controls-basic');
        const keepLayoutCheckbox = document.getElementById('keep-layout-checkbox');
        
        // New Nav Elements
        const navQwen = document.getElementById('nav-qwen');
        const navBasic = document.getElementById('nav-basic');
        const navAdvanced = document.getElementById('nav-advanced');
        const navHistory = document.getElementById('nav-history');

        const controlsContainer = document.getElementById('controls-container');
        const qwenOptionsContainer = document.getElementById('qwen-options-container');
        const controlsBasic = document.getElementById('controls-basic');
        const controlsAdvanced = document.getElementById('controls-advanced');
        const functionPreviewContainer = document.getElementById('function-preview-container');
        const functionPreviewImage = document.getElementById('function-preview-image');
        const fluxUpscaleControls = document.getElementById('flux-upscale-controls');
        
        const changeBgControls = document.getElementById('change-bg-controls');
        const refBgDropZone = document.getElementById('ref-bg-drop-zone');
        const refBgFileInput = document.getElementById('ref-bg-file-input');
        const refBgPreview = document.getElementById('ref-bg-preview');
        const refBgUploadPrompt = document.getElementById('ref-bg-upload-prompt');
        const removeRefBgBtn = document.getElementById('remove-ref-bg-btn');

        const ge2Controls = document.getElementById('ge-2-controls');
        const lessImpactCheckbox = document.getElementById('less-impact-checkbox');
        const ge8Controls = document.getElementById('ge-8-controls'); 
        const ge10Controls = document.getElementById('ge-10-controls');
        const clothingImgDropZone = document.getElementById('clothing-img-drop-zone');
        const clothingImgFileInput = document.getElementById('clothing-img-file-input');
        const clothingImgPreview = document.getElementById('clothing-img-preview');
        const clothingImgUploadPrompt = document.getElementById('clothing-img-upload-prompt');
        const removeClothingImgBtn = document.getElementById('remove-clothing-img-btn');
        
        // Face Swap Elements
        const faceSwapControls = document.getElementById('face-swap-controls');
        const faceSwapDropZone = document.getElementById('face-swap-drop-zone');
        const faceSwapFileInput = document.getElementById('face-swap-file-input');
        const faceSwapPreview = document.getElementById('face-swap-preview');
        const faceSwapUploadPrompt = document.getElementById('face-swap-upload-prompt');
        const removeFaceSwapBtn = document.getElementById('remove-face-swap-btn');

        // START: Qwen Reference Image Elements
        const qwenRefContainer = document.getElementById('qwen-ref-container');
        const qwenRefDropZone = document.getElementById('qwen-ref-drop-zone');
        const qwenRefFileInput = document.getElementById('qwen-ref-file-input');
        const qwenRefPreview = document.getElementById('qwen-ref-preview');
        const qwenRefUploadPrompt = document.getElementById('qwen-ref-upload-prompt');
        const removeQwenRefBtn = document.getElementById('remove-qwen-ref-btn');
        // END: Qwen Reference Image Elements
        
        // START: E-commerce Elements
        const ecommerceControls = document.getElementById('ecommerce-controls');
        const effectShadow = document.getElementById('effect-shadow');
        const effectMirror = document.getElementById('effect-mirror');
        // END: E-commerce Elements

        const previewBtn = document.getElementById('preview-btn');
        const useResultBtn = document.getElementById('use-result-btn');
        const useOriginalBtn = document.getElementById('use-original-btn');
        const downloadBtn = document.getElementById('download-btn');
        const previewModal = document.getElementById('preview-modal');
        const previewCompareContainer = document.getElementById('preview-compare-container');
        const previewTransformWrapper = document.getElementById('preview-transform-wrapper');
        const previewOriginalImage = document.getElementById('preview-original-image');
        const previewResultImage = document.getElementById('preview-result-image');
        const previewSliderHandle = document.getElementById('preview-slider-handle');
        const previewSliderIcon = document.getElementById('preview-slider-icon');
        const closePreviewBtn = document.getElementById('close-preview-btn');
        
        const historyModal = document.getElementById('history-modal');
        const historyPanel = document.getElementById('history-panel');
        const closeHistoryBtn = document.getElementById('close-history-btn');
        const historyGrid = document.getElementById('history-grid');

        // --- STATE MANAGEMENT ---
        let uploadedImageFile = null;
        let initialUploadedImageFile = null;
        let originalImageUrl = null;
        let referenceBgFile = null;
        let referenceBgUrl = null;
        let clothingImageFile = null;
        let clothingImageUrl = null;
        let faceSwapFile = null;
        let faceSwapUrl = null;
        let qwenReferenceFile = null; 
        let qwenReferenceUrl = null;  
        let activeProcessingMode = 'qwen'; 
        let imageHistory = [];
        let selectedEcommerceEffect = 1; // 1 for shadow, 2 for mirror
        
        let currentTaskId = null;
        let statusInterval = null;
        const API_KEY = "API key";

        const previewImages = {
            'flux_upscale': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759570520/tang_net-min_y7fvbl.gif',
            'change_bg': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759570523/thay_nen-min_vg2ydo.gif',
            'ge_2': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759569598/phuc_che_qi0xo4.gif',
            'ge_3': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759570516/delur-min_qhym2u.gif',
            'ge_22': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759572561/xoa_mun-min_wafsy0.gif',
            'ge_4': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759569590/makup_qjvzhf.gif',
            'ge_8': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759570316/blend-min_lp2igk.gif',
            'light_shadow': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759570987/light_and_shadow-min_szjbl5.gif',
            'ge_9': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759570530/san_pham-min_wgc42q.gif',
            'ge_10': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759648069/thay_trang_phuc4-01_wj35jq.jpg',
            'ge_14': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759650925/tach_trang_phuc-min_ibyn7g.gif',
            'ge_15': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759651988/trich_xuat_rnrczq.gif',
            'ge_17': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759650929/vector-min_cxcwgg.gif',
            'ge_11': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759650961/hoat_hinh-min_um3thj.gif',
            'ge_18': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759650929/3d_chibi-min_cfe0go.gif',
            'ge_19': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759650927/mau_nuoc-min_qj1vio.gif',
            'ge_20': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759650929/tranh_trung_quoc-min_dt6rr2.gif',
            'ge_13': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759649540/bien_hoa_nyhsqy.gif',
            'ge_12': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1760521288/anh_sang-min_bsqpwk.gif',
            'id_photo': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1760321242/anh_the-min_hncm4b.gif',
            'face_swap': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1760321276/face_swap-01_qsjs7r.jpg',
            'ge_30': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759650928/vien_vang-min_pdenyl.gif',
            // START NEW PREVIEW IMAGE
            'render_architecture': 'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1761291518/gif-1_1.5s_80p-min_up_xr8xac.gif'
            // END NEW PREVIEW IMAGE
        };

        // --- UI LOGIC (NEW NAVIGATION) ---
        function switchView(activeView) {
            navQwen.classList.remove('active');
            navBasic.classList.remove('active');
            navAdvanced.classList.remove('active');

            qwenOptionsContainer.style.display = 'none';
            controlsBasic.style.display = 'none';
            controlsAdvanced.style.display = 'none';
            functionPreviewContainer.style.display = 'none';

            if (activeView === 'qwen') {
                navQwen.classList.add('active');
                qwenOptionsContainer.style.display = 'flex';
                activeProcessingMode = 'qwen';
            } else if (activeView === 'basic') {
                navBasic.classList.add('active');
                controlsBasic.style.display = 'flex';
                activeProcessingMode = processingModeSelect.value;
            } else if (activeView === 'advanced') {
                navAdvanced.classList.add('active');
                controlsAdvanced.style.display = 'flex';
                activeProcessingMode = processingModeSelectAdvanced.value;
            }
            updateControlsUI();
        }

        function updateFunctionPreview(mode) {
            const imageUrl = previewImages[mode];
            if (imageUrl) {
                functionPreviewImage.src = imageUrl;
                functionPreviewContainer.style.display = 'block';
            } else {
                functionPreviewContainer.style.display = 'none';
            }
        }

        function updateControlsUI() {
            // Hide all specific sub-controls first
            aspectRatioContainer.style.display = 'none';
            upscaleControlsBasic.style.display = 'none';
            fluxUpscaleControls.style.display = 'none';
            changeBgControls.style.display = 'none';
            ge2Controls.style.display = 'none';
            ge8Controls.style.display = 'none';
            ge10Controls.style.display = 'none';
            ecommerceControls.style.display = 'none'; 
            faceSwapControls.style.display = 'none';

            // Show sub-controls based on the active mode
            if (activeProcessingMode === 'qwen') {
                if (keepLayoutCheckbox.checked) {
                    aspectRatioContainer.style.display = 'none';
                } else {
                    aspectRatioContainer.style.display = 'block';
                }
            } else if (activeProcessingMode === 'upscale') {
                upscaleControlsBasic.style.display = 'block';
            } else if (activeProcessingMode === 'flux_upscale') {
                fluxUpscaleControls.style.display = 'flex';
            } else if (activeProcessingMode === 'change_bg') {
                changeBgControls.style.display = 'flex';
            } else if (activeProcessingMode === 'ge_2') {
                ge2Controls.style.display = 'flex';
            } else if (activeProcessingMode === 'ge_10') {
                ge10Controls.style.display = 'flex';
            } else if (activeProcessingMode === 'ecommerce_process') { 
                ecommerceControls.style.display = 'flex';
            } else if (activeProcessingMode === 'face_swap') {
                faceSwapControls.style.display = 'flex';
            }

            // Update preview image for advanced controls
            if (navAdvanced.classList.contains('active')) {
                updateFunctionPreview(activeProcessingMode);
            } else {
                functionPreviewContainer.style.display = 'none';
            }
        }
        
        function handleModeChange(event) {
            activeProcessingMode = event.target.value;
            updateControlsUI();
        }

        navQwen.addEventListener('click', () => switchView('qwen'));
        navBasic.addEventListener('click', () => switchView('basic'));
        navAdvanced.addEventListener('click', () => switchView('advanced'));
        processingModeSelect.addEventListener('change', handleModeChange);
        processingModeSelectAdvanced.addEventListener('change', handleModeChange);
        keepLayoutCheckbox.addEventListener('change', updateControlsUI);
        
        // --- IMAGE UPLOAD LOGIC ---
        function handleFileSelect(file, isFromUserInput = false) {
            if (!file || !file.type.startsWith('image/')) return;
            if (isFromUserInput) initialUploadedImageFile = file;
            uploadedImageFile = file;
            if (originalImageUrl && originalImageUrl.startsWith('blob:')) URL.revokeObjectURL(originalImageUrl);
            originalImageUrl = URL.createObjectURL(file);
            imagePreview.src = originalImageUrl;
            imagePreviewContainer.style.display = 'block';
            originalImageDisplay.src = originalImageUrl;
            resultImage.src = '';
            resultImage.style.display = 'none'; 
            sliderHandle.style.display = 'none';
            originalImageDisplay.style.clipPath = 'none'; 
            imageCompareContainer.classList.remove('dragging');
            fallbackImage.style.display = 'none';
            imageCompareContainer.style.display = 'block';
        }
        
        fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0], true));
        promptContainer.addEventListener('dragover', (e) => { e.preventDefault(); e.currentTarget.style.backgroundColor = '#e0e0e0'; });
        promptContainer.addEventListener('dragleave', (e) => { e.currentTarget.style.backgroundColor = 'white'; });
        promptContainer.addEventListener('drop', (e) => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'white'; handleFileSelect(e.dataTransfer.files[0], true); });
        window.addEventListener('paste', (e) => {
            if (document.activeElement !== refBgDropZone && document.activeElement !== clothingImgDropZone && document.activeElement !== qwenRefDropZone && document.activeElement !== faceSwapDropZone) {
                for (const item of e.clipboardData.items) {
                    if (item.kind === 'file' && item.type.startsWith('image/')) {
                        handleFileSelect(item.getAsFile(), true);
                        break;
                    }
                }
            }
        });
        removeImageBtn.addEventListener('click', () => { uploadedImageFile = null; initialUploadedImageFile = null; if (originalImageUrl && originalImageUrl.startsWith('blob:')) URL.revokeObjectURL(originalImageUrl); originalImageUrl = null; fileInput.value = ''; imagePreviewContainer.style.display = 'none'; imageCompareContainer.style.display = 'none'; fallbackImage.style.display = 'block'; });

        function handleReferenceBgFileSelect(file) { if (!file || !file.type.startsWith('image/')) return; referenceBgFile = file; if (referenceBgUrl) URL.revokeObjectURL(referenceBgUrl); referenceBgUrl = URL.createObjectURL(file); refBgPreview.src = referenceBgUrl; refBgPreview.style.display = 'block'; refBgUploadPrompt.style.display = 'none'; removeRefBgBtn.style.display = 'flex'; }
        refBgDropZone.addEventListener('click', () => refBgFileInput.click());
        refBgFileInput.addEventListener('change', (e) => handleReferenceBgFileSelect(e.target.files[0]));
        refBgDropZone.addEventListener('dragover', (e) => { e.preventDefault(); refBgDropZone.classList.add('drop-zone-active'); });
        refBgDropZone.addEventListener('dragleave', () => refBgDropZone.classList.remove('drop-zone-active'));
        refBgDropZone.addEventListener('drop', (e) => { e.preventDefault(); refBgDropZone.classList.remove('drop-zone-active'); if (e.dataTransfer.files.length > 0) handleReferenceBgFileSelect(e.dataTransfer.files[0]); });
        refBgDropZone.addEventListener('paste', (e) => { e.stopPropagation(); for (const item of e.clipboardData.items) { if (item.kind === 'file' && item.type.startsWith('image/')) { handleReferenceBgFileSelect(item.getAsFile()); break; } } });
        removeRefBgBtn.addEventListener('click', (e) => { e.stopPropagation(); referenceBgFile = null; if (referenceBgUrl) URL.revokeObjectURL(referenceBgUrl); referenceBgUrl = null; refBgFileInput.value = ''; refBgPreview.src = ''; refBgPreview.style.display = 'none'; refBgUploadPrompt.style.display = 'block'; removeRefBgBtn.style.display = 'none'; });

        function handleClothingImageFileSelect(file) {
            if (!file || !file.type.startsWith('image/')) return;
            clothingImageFile = file;
            if (clothingImageUrl) URL.revokeObjectURL(clothingImageUrl);
            clothingImageUrl = URL.createObjectURL(file);
            clothingImgPreview.src = clothingImageUrl;
            clothingImgPreview.style.display = 'block';
            clothingImgUploadPrompt.style.display = 'none';
            removeClothingImgBtn.style.display = 'flex';
        }
        clothingImgDropZone.addEventListener('click', () => clothingImgFileInput.click());
        clothingImgFileInput.addEventListener('change', (e) => handleClothingImageFileSelect(e.target.files[0]));
        clothingImgDropZone.addEventListener('dragover', (e) => { e.preventDefault(); clothingImgDropZone.classList.add('drop-zone-active'); });
        clothingImgDropZone.addEventListener('dragleave', () => clothingImgDropZone.classList.remove('drop-zone-active'));
        clothingImgDropZone.addEventListener('drop', (e) => { e.preventDefault(); clothingImgDropZone.classList.remove('drop-zone-active'); if (e.dataTransfer.files.length > 0) handleClothingImageFileSelect(e.dataTransfer.files[0]); });
        clothingImgDropZone.addEventListener('paste', (e) => { e.stopPropagation(); for (const item of e.clipboardData.items) { if (item.kind === 'file' && item.type.startsWith('image/')) { handleClothingImageFileSelect(item.getAsFile()); break; } } });
        removeClothingImgBtn.addEventListener('click', (e) => { e.stopPropagation(); clothingImageFile = null; if (clothingImageUrl) URL.revokeObjectURL(clothingImageUrl); clothingImageUrl = null; clothingImgFileInput.value = ''; clothingImgPreview.src = ''; clothingImgPreview.style.display = 'none'; clothingImgUploadPrompt.style.display = 'block'; removeClothingImgBtn.style.display = 'none'; });

        // START: New Qwen Reference Image Handlers
        function handleQwenRefFileSelect(file) {
            if (!file || !file.type.startsWith('image/')) return;
            qwenReferenceFile = file;
            if (qwenReferenceUrl) URL.revokeObjectURL(qwenReferenceUrl);
            qwenReferenceUrl = URL.createObjectURL(file);
            qwenRefPreview.src = qwenReferenceUrl;
            qwenRefPreview.style.display = 'block';
            qwenRefUploadPrompt.style.display = 'none';
            removeQwenRefBtn.style.display = 'flex';
        }
        qwenRefDropZone.addEventListener('click', () => qwenRefFileInput.click());
        qwenRefFileInput.addEventListener('change', (e) => handleQwenRefFileSelect(e.target.files[0]));
        qwenRefDropZone.addEventListener('dragover', (e) => { e.preventDefault(); qwenRefDropZone.classList.add('drop-zone-active'); });
        qwenRefDropZone.addEventListener('dragleave', () => qwenRefDropZone.classList.remove('drop-zone-active'));
        qwenRefDropZone.addEventListener('drop', (e) => { e.preventDefault(); qwenRefDropZone.classList.remove('drop-zone-active'); if (e.dataTransfer.files.length > 0) handleQwenRefFileSelect(e.dataTransfer.files[0]); });
        qwenRefDropZone.addEventListener('paste', (e) => { e.stopPropagation(); for (const item of e.clipboardData.items) { if (item.kind === 'file' && item.type.startsWith('image/')) { handleQwenRefFileSelect(item.getAsFile()); break; } } });
        removeQwenRefBtn.addEventListener('click', (e) => { e.stopPropagation(); qwenReferenceFile = null; if (qwenReferenceUrl) URL.revokeObjectURL(qwenReferenceUrl); qwenReferenceUrl = null; qwenRefFileInput.value = ''; qwenRefPreview.src = ''; qwenRefPreview.style.display = 'none'; qwenRefUploadPrompt.style.display = 'block'; removeQwenRefBtn.style.display = 'none'; });
        // END: New Qwen Reference Image Handlers
        
        // START: New Face Swap Image Handlers
        function handleFaceSwapFileSelect(file) {
            if (!file || !file.type.startsWith('image/')) return;
            faceSwapFile = file;
            if (faceSwapUrl) URL.revokeObjectURL(faceSwapUrl);
            faceSwapUrl = URL.createObjectURL(file);
            faceSwapPreview.src = faceSwapUrl;
            faceSwapPreview.style.display = 'block';
            faceSwapUploadPrompt.style.display = 'none';
            removeFaceSwapBtn.style.display = 'flex';
        }
        faceSwapDropZone.addEventListener('click', () => faceSwapFileInput.click());
        faceSwapFileInput.addEventListener('change', (e) => handleFaceSwapFileSelect(e.target.files[0]));
        faceSwapDropZone.addEventListener('dragover', (e) => { e.preventDefault(); faceSwapDropZone.classList.add('drop-zone-active'); });
        faceSwapDropZone.addEventListener('dragleave', () => faceSwapDropZone.classList.remove('drop-zone-active'));
        faceSwapDropZone.addEventListener('drop', (e) => { e.preventDefault(); faceSwapDropZone.classList.remove('drop-zone-active'); if (e.dataTransfer.files.length > 0) handleFaceSwapFileSelect(e.dataTransfer.files[0]); });
        faceSwapDropZone.addEventListener('paste', (e) => { e.stopPropagation(); for (const item of e.clipboardData.items) { if (item.kind === 'file' && item.type.startsWith('image/')) { handleFaceSwapFileSelect(item.getAsFile()); break; } } });
        removeFaceSwapBtn.addEventListener('click', (e) => { e.stopPropagation(); faceSwapFile = null; if (faceSwapUrl) URL.revokeObjectURL(faceSwapUrl); faceSwapUrl = null; faceSwapFileInput.value = ''; faceSwapPreview.src = ''; faceSwapPreview.style.display = 'none'; faceSwapUploadPrompt.style.display = 'block'; removeFaceSwapBtn.style.display = 'none'; });
        // END: New Face Swap Image Handlers

        // START: E-commerce effect selection logic
        effectShadow.addEventListener('click', () => {
            selectedEcommerceEffect = 1;
            effectShadow.classList.replace('border-transparent', 'border-blue-500');
            effectMirror.classList.replace('border-blue-500', 'border-transparent');
        });

        effectMirror.addEventListener('click', () => {
            selectedEcommerceEffect = 2;
            effectMirror.classList.replace('border-transparent', 'border-blue-500');
            effectShadow.classList.replace('border-blue-500', 'border-transparent');
        });
        // END: E-commerce effect selection logic

        // --- CORE API LOGIC ---
        sendBtn.addEventListener('click', handleImageProcessing);
        promptInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleImageProcessing(); } });
        cancelBtn.addEventListener('click', cancelTask);

        function resetState() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
            currentTaskId = null;
            errorMessage.textContent = '';
            setUiLoading(false);
        }
        
        function setUiLoading(isLoading, message = '') {
            if (isLoading) {
                statusMessage.textContent = message;
                errorMessage.textContent = '';
                if (originalImageUrl) {
                    loadingBgImage.src = originalImageUrl;
                    loadingBgImage.style.display = 'block';
                    loadingOverlayColor.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
                } else {
                    loadingBgImage.style.display = 'none';
                    loadingOverlayColor.style.backgroundColor = 'rgb(30, 30, 30)';
                }
                statusOverlay.style.display = 'flex'; 
            } else {
                statusOverlay.style.display = 'none';
            }
        }

        async function uploadToRunningHub(imageFile) {
            const formData = new FormData();
            formData.append('file', imageFile);
            formData.append('apiKey', API_KEY);
            formData.append('fileType', 'image');
            
            const uploadUrl = 'https://www.runninghub.ai/task/openapi/upload';
            const response = await fetch(uploadUrl, { method: 'POST', body: formData });

            if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                const errorMessageText = errorData?.msg || \`Lỗi HTTP: \${response.status}\`;
                throw new Error(\`Tải ảnh lên RunningHub thất bại: \${errorMessageText}\`);
            }
            
            const data = await response.json();
            if (data.code !== 0 || !data.data || !data.data.fileName) {
                throw new Error(\`API tải ảnh lên báo lỗi: \${data.msg || 'Không nhận được đường dẫn file'}\`);
            }
            
            return data.data.fileName; // Return relative path
        }
        
        async function handleImageProcessing() {
            resetState();
            const selectedMode = activeProcessingMode;
            const promptText = promptInput.value.trim();
            const keepLayout = keepLayoutCheckbox.checked;

            // START UPDATED ARRAY
            const imageRequiredModes = ['removebg', 'mask', 'upscale', 'flux_upscale', 'light_shadow', 'change_bg', 'ecommerce_process', 'face_swap', 'id_photo', 'render_architecture'];
            // END UPDATED ARRAY
            if (selectedMode.startsWith('ge_')) imageRequiredModes.push(selectedMode);
            
            if (selectedMode === 'qwen' && qwenReferenceFile && !uploadedImageFile) { errorMessage.textContent = 'Chức năng này yêu cầu cả ảnh chính và ảnh tham chiếu!'; setTimeout(() => errorMessage.textContent = '', 3000); return; }
            if (!uploadedImageFile && imageRequiredModes.includes(selectedMode)) { errorMessage.textContent = 'Chức năng này yêu cầu phải có ảnh!'; setTimeout(() => errorMessage.textContent = '', 3000); return; }
            if (selectedMode === 'qwen' && keepLayout && (!uploadedImageFile || !promptText)) { errorMessage.textContent = 'Chức năng "Giữ bố cục" yêu cầu cả ảnh và prompt!'; setTimeout(() => errorMessage.textContent = '', 3000); return; }
            if (selectedMode === 'qwen' && !keepLayout && !uploadedImageFile && !promptText && !qwenReferenceFile) { errorMessage.textContent = 'Vui lòng nhập prompt hoặc tải ảnh lên!'; setTimeout(() => errorMessage.textContent = '', 3000); return; }
            if (selectedMode === 'face_swap' && !faceSwapFile) { errorMessage.textContent = 'Chức năng này yêu cầu ảnh khuôn mặt cần thay thế!'; setTimeout(() => errorMessage.textContent = '', 3000); return; }
            
            setUiLoading(true, 'Đang tải ảnh lên...');
            try {
                const uploadPromises = [];
                if (uploadedImageFile) uploadPromises.push(uploadToRunningHub(uploadedImageFile));
                if (selectedMode === 'change_bg' && referenceBgFile) uploadPromises.push(uploadToRunningHub(referenceBgFile));
                if (selectedMode === 'ge_10' && clothingImageFile) uploadPromises.push(uploadToRunningHub(clothingImageFile));
                if (selectedMode === 'qwen' && qwenReferenceFile) uploadPromises.push(uploadToRunningHub(qwenReferenceFile));
                if (selectedMode === 'face_swap' && faceSwapFile) uploadPromises.push(uploadToRunningHub(faceSwapFile));
                
                const uploadedUrls = await Promise.all(uploadPromises);

                let urlIndex = 0;
                let imageUrlForApi = uploadedImageFile ? uploadedUrls[urlIndex++] : null;
                let referenceBgUrlForApi = (selectedMode === 'change_bg' && referenceBgFile) ? uploadedUrls[urlIndex++] : null;
                let clothingImageUrlForApi = (selectedMode === 'ge_10' && clothingImageFile) ? uploadedUrls[urlIndex++] : null;
                let qwenRefUrlForApi = (selectedMode === 'qwen' && qwenReferenceFile) ? uploadedUrls[urlIndex++] : null;
                let faceSwapUrlForApi = (selectedMode === 'face_swap' && faceSwapFile) ? uploadedUrls[urlIndex++] : null;


                setUiLoading(true, 'Đang khởi tạo tác vụ...');
                let webappId, nodeInfoList;
                
                if (selectedMode.startsWith('ge_')) {
                    if (selectedMode === 'ge_8') {
                        webappId = "1973954014482141186";
                        nodeInfoList = [{
                            "nodeId": "22",
                            "fieldName": "image",
                            "fieldValue": imageUrlForApi,
                            "description": "Image"
                        }];
                    } else if (selectedMode === 'ge_2') {
                        if (lessImpactCheckbox.checked) {
                            webappId = "1956669205624053761";
                            nodeInfoList = [
                                { nodeId: "41", fieldName: "image", fieldValue: imageUrlForApi }, 
                                { nodeId: "32", fieldName: "value", fieldValue: "27" }, 
                                { nodeId: "33", fieldName: "text", fieldValue: promptText }
                            ];
                        } else {
                             webappId = "1973579606852767746";
                            nodeInfoList = [{
                                "nodeId": "64",
                                "fieldName": "image",
                                "fieldValue": imageUrlForApi,
                                "description": "Image"
                            }];
                        }
                    } else if (selectedMode === 'ge_10' && clothingImageFile && clothingImageUrlForApi) {
                        webappId = "1967543086240948226";
                        nodeInfoList = [
                            { nodeId: "562", fieldName: "image", fieldValue: imageUrlForApi, description: "Người mẫu" },
                            { nodeId: "563", fieldName: "image", fieldValue: clothingImageUrlForApi, description: "Trang phục" }
                        ];
                    } else {
                        webappId = "1956669205624053761";
                        let modeValue = selectedMode.split('_')[1];
                        nodeInfoList = [
                            { nodeId: "41", fieldName: "image", fieldValue: imageUrlForApi }, 
                            { nodeId: "32", fieldName: "value", fieldValue: modeValue }, 
                            { nodeId: "33", fieldName: "text", fieldValue: promptText }
                        ];
                    }
                } else {
                    switch (selectedMode) {
                        case 'qwen':
                            if (qwenReferenceFile && qwenRefUrlForApi && imageUrlForApi) {
                                webappId = "1971891903639842817";
                                nodeInfoList = [
                                    { nodeId: "230", fieldName: "image", fieldValue: imageUrlForApi, description: "Image" },
                                    { nodeId: "234", fieldName: "image", fieldValue: qwenRefUrlForApi, description: "Style Image" },
                                    { nodeId: "258", fieldName: "text", fieldValue: promptText, description: "Prompt" }
                                ];
                            } else if (keepLayout) {
                                webappId = "1969316411724230657";
                                nodeInfoList = [
                                    { nodeId: "107", fieldName: "image", fieldValue: imageUrlForApi },
                                    { nodeId: "199", fieldName: "text", fieldValue: promptText }
                                ];
                            } else {
                                webappId = "1958148065536462850";
                                nodeInfoList = [
                                    { nodeId: "159", fieldName: "value", fieldValue: imageUrlForApi ? "1" : "0" },
                                    { nodeId: "156", fieldName: "value", fieldValue: aspectRatioSelect.value },
                                    { nodeId: "147", fieldName: "text", fieldValue: promptText }
                                ];
                                if (imageUrlForApi) nodeInfoList.push({ nodeId: "115", fieldName: "image", fieldValue: imageUrlForApi });
                            }
                            break;
                        case 'ecommerce_process':
                            webappId = "1972971898822897665";
                            nodeInfoList = [
                                { nodeId: "84", fieldName: "image", fieldValue: imageUrlForApi, description: "Image" },
                                { nodeId: "98", fieldName: "value", fieldValue: selectedEcommerceEffect.toString(), description: "[ 1: shadow] - [ 2: mirror ]" }
                            ];
                            break;
                        case 'id_photo':
                            webappId = "1975402280528818177";
                            nodeInfoList = [
                                { nodeId: "51", fieldName: "image", fieldValue: imageUrlForApi, description: "Image" },
                                { nodeId: "54", fieldName: "text", fieldValue: promptText, description: "Prompt" }
                            ];
                            break;
                        case 'face_swap':
                            webappId = "1977655752284360705";
                            nodeInfoList = [
                                { nodeId: "178", fieldName: "image", fieldValue: imageUrlForApi, description: "Subject" },
                                { nodeId: "542", fieldName: "image", fieldValue: faceSwapUrlForApi, description: "Face" }
                            ];
                            break;
                        case 'removebg': case 'mask': webappId = "1956204712976678913"; let modeValue = (selectedMode === 'removebg') ? '1' : '2'; nodeInfoList = [ { nodeId: "28", fieldName: "image", fieldValue: imageUrlForApi }, { nodeId: "77", fieldName: "value", fieldValue: modeValue } ]; break;
                        case 'upscale': webappId = "1957633371671293954"; nodeInfoList = [ { nodeId: "1", fieldName: "image", fieldValue: imageUrlForApi }, { nodeId: "11", fieldName: "value", fieldValue: document.getElementById('upscale-level').value } ]; break;
                        case 'flux_upscale':
                            const fluxModel = document.getElementById('flux-upscale-model').value;
                            webappId = (fluxModel === 'realesrgan') ? "1965717590683353089" : "1955475385950486530";
                            nodeInfoList = (fluxModel === 'realesrgan') ? [{ nodeId: "33", fieldName: "image", fieldValue: imageUrlForApi }] : [{ nodeId: "6", fieldName: "image", fieldValue: imageUrlForApi }];
                            break;
                        case 'change_bg': if (referenceBgFile && referenceBgUrlForApi) { webappId = "1961706336507641857"; nodeInfoList = [{ nodeId: "49", fieldName: "image", fieldValue: imageUrlForApi }, { nodeId: "245", fieldName: "image", fieldValue: referenceBgUrlForApi }]; } else { webappId = "1956669205624053761"; nodeInfoList = [{ nodeId: "41", fieldName: "image", fieldValue: imageUrlForApi }, { nodeId: "32", fieldName: "value", fieldValue: "16" }, { nodeId: "33", fieldName: "text", fieldValue: promptText }]; } break;
                        case 'light_shadow': webappId = "1960150976252555265"; nodeInfoList = [{ nodeId: "47", fieldName: "image", fieldValue: imageUrlForApi }]; break;
                        // START NEW CASE
                        case 'render_architecture':
                            webappId = "1980849016827236354";
                            nodeInfoList = [
                                {
                                    "nodeId": "94",
                                    "fieldName": "image",
                                    "fieldValue": imageUrlForApi,
                                    "description": "image"
                                },
                                {
                                    "nodeId": "139",
                                    "fieldName": "text",
                                    "fieldValue": promptText,
                                    "description": "text"
                                }
                            ];
                            break;
                        // END NEW CASE
                    }
                }
                const runPayload = { webappId, apiKey: API_KEY, nodeInfoList };
                const runUrl = 'https://www.runninghub.ai/task/openapi/ai-app/run';
                const runResponse = await fetch(runUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(runPayload) });
                if (!runResponse.ok) throw new Error(\`Lỗi khi chạy tác vụ: \${runResponse.statusText}\`);
                
                const runResult = await runResponse.json();
                if (runResult.code !== 0 || !runResult.data.taskId) {
                     throw new Error(\`API không khởi động được tác vụ: \${runResult.msg || 'Không nhận được Task ID'}\`);
                }
                currentTaskId = runResult.data.taskId;

                setUiLoading(true, 'Đang xử lý...');
                statusInterval = setInterval(checkTaskStatus, 3000);
            } catch (error) {
                console.error('Lỗi trong quy trình:', error);
                errorMessage.textContent = error.message;
                setUiLoading(false);
            }
        }
        
        async function checkTaskStatus() {
            const taskIdToCheck = currentTaskId;
            if (!taskIdToCheck) {
                if (statusInterval) clearInterval(statusInterval);
                statusInterval = null;
                return;
            }

            try {
                const statusUrl = 'https://www.runninghub.ai/task/openapi/status';
                const payload = { apiKey: API_KEY, taskId: taskIdToCheck };
                const response = await fetch(statusUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (currentTaskId !== taskIdToCheck) {
                    return; 
                }

                if (!response.ok) throw new Error(\`Lỗi kiểm tra trạng thái: \${response.statusText}\`);
                
                const result = await response.json();
                if (result.code !== 0) throw new Error(\`Lỗi API trạng thái: \${result.msg}\`);

                const statusData = result.data || {};
                const status = typeof statusData === 'string' ? statusData : statusData.status;

                switch (status) {
                    case 'SUCCESS':
                        clearInterval(statusInterval);
                        statusInterval = null;
                        fetchTaskOutput(taskIdToCheck); 
                        break;
                    case 'RUNNING': case 'PROCESSING':
                        const progress = statusData.progress ? Math.round(statusData.progress * 100) : 0;
                        setUiLoading(true, \`Đang xử lý... \${progress > 0 ? progress + '%' : ''}\`);
                        break;
                    case 'IN_QUEUE': setUiLoading(true, 'Đang xử lý...'); break;
                    case 'FAILED':
                        clearInterval(statusInterval);
                        statusInterval = null;
                        throw new Error(statusData.failReason || 'Tác vụ thất bại trên server.');
                    default:
                        setUiLoading(true, \`Trạng thái: \${status || 'Không xác định'}\`);
                        break;
                }
            } catch (error) {
                console.error('Lỗi khi kiểm tra trạng thái:', error);
                errorMessage.textContent = error.message;
                if (currentTaskId === taskIdToCheck) {
                    setUiLoading(false);
                    if (statusInterval) clearInterval(statusInterval);
                    statusInterval = null;
                }
            }
        }

        async function fetchTaskOutput(taskId) {
            try {
                const outputUrl = 'https://www.runninghub.ai/task/openapi/outputs';
                const payload = { apiKey: API_KEY, taskId: taskId };
                const response = await fetch(outputUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(\`Lỗi lấy kết quả: \${response.statusText}\`);
                
                const result = await response.json();
                if (result.code !== 0) throw new Error(\`API báo lỗi: \${result.msg || 'Lỗi không xác định'}\`);
                if (!result.data) throw new Error('API không trả về dữ liệu kết quả.');

                const output = result.data.outputs || result.data;
                let finalImageUrl = null;
                
                for (const key in output) {
                    const node = output[key];
                    if (typeof node !== 'object' || node === null) continue;
                    if (node?.images?.[0]?.url) { finalImageUrl = node.images[0].url; break; }
                    if (Array.isArray(node) && node[0]?.url) { finalImageUrl = node[0].url; break; }
                    if (node?.fileUrl) { finalImageUrl = node.fileUrl; break; }
                }
                
                if (finalImageUrl) {
                    saveImageToHistory(finalImageUrl);
                    if (originalImageUrl) {
                        resultImage.src = finalImageUrl;
                        resultImage.style.display = 'block';
                        sliderHandle.style.display = 'block';
                        updateSlider(50, originalImageDisplay, resultImage, sliderHandle);
                    } else {
                        originalImageDisplay.src = finalImageUrl;
                        originalImageUrl = finalImageUrl; 
                        resultImage.src = '';
                        resultImage.style.display = 'none';
                        originalImageDisplay.style.clipPath = 'none';
                        imageCompareContainer.style.display = 'block';
                        fallbackImage.style.display = 'none';
                        sliderHandle.style.display = 'none';
                    }
                } else { throw new Error('Không tìm thấy hình ảnh trong kết quả trả về.'); }
            } catch (error) {
                console.error('Lỗi khi lấy kết quả:', error);
                errorMessage.textContent = error.message;
            } finally {
                if (currentTaskId === taskId) {
                    setUiLoading(false);
                    currentTaskId = null;
                }
            }
        }

        async function cancelTask() {
            if (!currentTaskId) return;
            const taskIdToCancel = currentTaskId;
            resetState();
            try {
                const cancelUrl = 'https://www.runninghub.ai/task/openapi/cancel';
                const payload = { apiKey: API_KEY, taskId: taskIdToCancel };
                const response = await fetch(cancelUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.code !== 0) console.warn(\`API báo lỗi khi hủy tác vụ: \${result.msg}\`);
            } catch (error) { console.error('Lỗi khi hủy tác vụ:', error); }
        }

        // --- IMAGE COMPARER & PREVIEW LOGIC ---
        function updateSlider(percentage, leftImg, rightImg, handle) {
            percentage = Math.max(0, Math.min(100, percentage));
            leftImg.style.clipPath = \`polygon(0 0, \${percentage}% 0, \${percentage}% 100%, 0 100%)\`;
            rightImg.style.clipPath = \`polygon(\${percentage}% 0, 100% 0, 100% 100%, \${percentage}% 100%)\`;
            if (handle) handle.style.left = \`\${percentage}%\`;
        }

        // --- Main Slider Logic ---
        let isDraggingSlider = false;
        
        function startDrag(e, isPreview = false) {
             if (!resultImage.src) return;
             e.preventDefault();
             e.stopPropagation();
             if(isPreview) {
                isDraggingPreviewSlider = true;
             } else {
                isDraggingSlider = true;
                imageCompareContainer.classList.add('dragging');
             }
        }

        function stopDrag() {
            if (isDraggingSlider) {
                isDraggingSlider = false;
                imageCompareContainer.classList.remove('dragging');
                 const rect = imageCompareContainer.getBoundingClientRect();
                 const isMouseOver = window.event.clientX >= rect.left && window.event.clientX <= rect.right &&
                                   window.event.clientY >= rect.top && window.event.clientY <= rect.bottom;
                 if (!isMouseOver) {
                     sliderIcon.style.opacity = '0';
                 }
            }
            if (isDraggingPreviewSlider) {
                isDraggingPreviewSlider = false;
                previewCompareContainer.classList.remove('grabbing');
                const rect = previewCompareContainer.getBoundingClientRect();
                 const isMouseOver = window.event.clientX >= rect.left && window.event.clientX <= rect.right &&
                                   window.event.clientY >= rect.top && window.event.clientY <= rect.bottom;
                 if (!isMouseOver) {
                     previewSliderIcon.style.opacity = '0';
                 }
            }
        }
        
        function doDrag(e) {
            if (!isDraggingSlider) return;
            const rect = imageCompareContainer.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const x = clientX - rect.left;
            const y = clientY - rect.top;

            updateSlider((x / rect.width) * 100, originalImageDisplay, resultImage, sliderHandle);
            sliderIcon.style.top = \`\${Math.max(0, Math.min(y - (sliderIcon.offsetHeight / 2), rect.height - sliderIcon.offsetHeight))}px\`;
        }
        
        sliderHandle.addEventListener('mousedown', (e) => startDrag(e, false));
        window.addEventListener('mouseup', stopDrag);
        window.addEventListener('mousemove', doDrag);
        sliderHandle.addEventListener('touchstart', (e) => startDrag(e, false), { passive: false });
        window.addEventListener('touchend', stopDrag);
        window.addEventListener('touchmove', doDrag, { passive: false });

        imageCompareContainer.addEventListener('mouseenter', () => { if (resultImage.src) { sliderIcon.style.opacity = '1'; } });
        imageCompareContainer.addEventListener('mouseleave', () => { if (!isDraggingSlider) { sliderIcon.style.opacity = '0'; } });
        imageCompareContainer.addEventListener('mousemove', (e) => {
            if (!isDraggingSlider && resultImage.src) {
                const rect = imageCompareContainer.getBoundingClientRect();
                const y = e.clientY - rect.top;
                sliderIcon.style.top = \`\${Math.max(0, Math.min(y - (sliderIcon.offsetHeight / 2), rect.height - sliderIcon.offsetHeight))}px\`;
            }
        });


        // --- Preview Modal Logic ---
        let scale = 1, panX = 0, panY = 0, isPanning = false, isDraggingPreviewSlider = false, start = { x: 0, y: 0 };
        let previewImageWidth = 1, previewImageHeight = 1;

        function updateTransform() { 
            const transform = \`translate(\${panX}px, \${panY}px) scale(\${scale})\`; 
            previewTransformWrapper.style.transform = transform; 
        }
        
        previewBtn.addEventListener('click', () => { 
            if (!originalImageDisplay.src) return; 
            previewOriginalImage.src = originalImageDisplay.src; 
            previewResultImage.src = resultImage.src || originalImageDisplay.src; 
            
            const loadImage = (img) => new Promise(resolve => { 
                if (img.complete && img.naturalHeight !== 0) { resolve(img); } 
                else { img.onload = () => resolve(img); } 
            }); 
            
            Promise.all([loadImage(previewOriginalImage), loadImage(previewResultImage)]).then(([img1, img2]) => { 
                const maxW = Math.max(img1.naturalWidth, img2.naturalWidth); 
                const maxH = Math.max(img1.naturalHeight, img2.naturalHeight); 
                previewImageWidth = maxW; 
                previewImageHeight = maxH; 

                previewTransformWrapper.style.width = \`\${maxW}px\`;
                previewTransformWrapper.style.height = \`\${maxH}px\`;
                previewOriginalImage.style.width = \`100%\`; 
                previewOriginalImage.style.height = \`100%\`; 
                previewResultImage.style.width = \`100%\`; 
                previewResultImage.style.height = \`100%\`;
                
                const modalWidth = previewModal.clientWidth; 
                const modalHeight = previewModal.clientHeight; 
                scale = Math.min(modalWidth / maxW, modalHeight / maxH); 
                panX = (modalWidth - maxW * scale) / 2; 
                panY = (modalHeight - maxH * scale) / 2; 
                updateTransform(); 
                
                if (previewOriginalImage.src !== previewResultImage.src) { 
                    previewSliderHandle.style.display = 'block';
                    updateSlider(50, previewOriginalImage, previewResultImage, previewSliderHandle); 
                } else { 
                    previewSliderHandle.style.display = 'none';
                    updateSlider(100, previewOriginalImage, previewResultImage, null); 
                } 
            }); 
            
            previewModal.classList.remove('hidden'); 
            previewCompareContainer.style.display = 'block'; 
        });
        
        closePreviewBtn.addEventListener('click', () => { previewModal.classList.add('hidden'); });
        
        function startPan(e) {
            // Only pan if the target is not the slider handle or its children
            if (e.target === previewSliderHandle || previewSliderHandle.contains(e.target)) return;

            e.preventDefault();
            const isTouchEvent = e.touches && e.touches.length > 0;
            const clientX = isTouchEvent ? e.touches[0].clientX : e.clientX;
            const clientY = isTouchEvent ? e.touches[0].clientY : e.clientY;

            isPanning = true; 
            previewCompareContainer.classList.add('grabbing'); 
            start = { x: clientX - panX, y: clientY - panY }; 
        }

        function stopPan() {
            if (isPanning) {
                isPanning = false;
                previewCompareContainer.classList.remove('grabbing');
            }
        }

        function handlePreviewMove(e) {
            const isTouchEvent = e.touches && e.touches.length > 0;
            if (isTouchEvent && (isPanning || isDraggingPreviewSlider)) {
                e.preventDefault();
            }

            const clientX = isTouchEvent ? e.touches[0].clientX : e.clientX;
            const clientY = isTouchEvent ? e.touches[0].clientY : e.clientY;

            const rect = previewCompareContainer.getBoundingClientRect();
            const pointerX = clientX - rect.left;
            const pointerY = clientY - rect.top;
            
            const pointerXOnWrapper = (pointerX - panX) / scale;
            const pointerYOnWrapper = (pointerY - panY) / scale;

            if (isPanning) { 
                panX = clientX - start.x; 
                panY = clientY - start.y; 
                updateTransform(); 
            } else if (isDraggingPreviewSlider) {
                const percentage = (pointerXOnWrapper / previewImageWidth) * 100;
                updateSlider(percentage, previewOriginalImage, previewResultImage, previewSliderHandle);
                previewSliderIcon.style.top = \`\${Math.max(0, Math.min(pointerYOnWrapper - (previewSliderIcon.offsetHeight / 2), previewImageHeight - previewSliderIcon.offsetHeight))}px\`;
            } else if (previewOriginalImage.src !== previewResultImage.src) {
                previewSliderIcon.style.top = \`\${Math.max(0, Math.min(pointerYOnWrapper - (previewSliderIcon.offsetHeight / 2), previewImageHeight - previewSliderIcon.offsetHeight))}px\`;
            }
        }

        previewCompareContainer.addEventListener('mousedown', startPan);
        previewCompareContainer.addEventListener('touchstart', startPan, { passive: false });
        previewSliderHandle.addEventListener('mousedown', (e) => startDrag(e, true));
        previewSliderHandle.addEventListener('touchstart', (e) => startDrag(e, true), { passive: false });
        
        window.addEventListener('mouseup', stopPan);
        window.addEventListener('touchend', stopPan);
        
        previewCompareContainer.addEventListener('mousemove', handlePreviewMove);
        previewCompareContainer.addEventListener('touchmove', handlePreviewMove, { passive: false });

        previewCompareContainer.addEventListener('mouseenter', () => { if (previewOriginalImage.src !== previewResultImage.src) { previewSliderIcon.style.opacity = '1'; } });
        previewCompareContainer.addEventListener('mouseleave', () => { if (!isDraggingPreviewSlider) { previewSliderIcon.style.opacity = '0'; } });
        
        previewModal.addEventListener('wheel', (e) => { 
            e.preventDefault(); 
            const rect = previewModal.getBoundingClientRect(); 
            const xs = (e.clientX - rect.left - panX) / scale; 
            const ys = (e.clientY - rect.top - panY) / scale; 
            const delta = -e.deltaY; 
            const newScale = scale * Math.pow(1.1, delta > 0 ? 1 : -1); 
            panX += xs * scale - xs * newScale; 
            panY += ys * scale - ys * newScale; 
            scale = newScale; 
            updateTransform(); 
        });
        
        
        // --- BUTTONS & HISTORY LOGIC ---
        useOriginalBtn.addEventListener('click', () => { if (initialUploadedImageFile) { handleFileSelect(initialUploadedImageFile, true); } else { alert("Không có ảnh gốc ban đầu để sử dụng."); } });
        useResultBtn.addEventListener('click', async () => { const imageUrlToUse = (resultImage.src && !resultImage.src.startsWith('https://placehold.co')) ? resultImage.src : (originalImageDisplay.src && !originalImageDisplay.src.startsWith('blob:') && !originalImageDisplay.src.startsWith('https://placehold.co')) ? originalImageDisplay.src : null; if (!imageUrlToUse) { alert("Không có ảnh kết quả để sử dụng."); return; } try { setUiLoading(true, 'Đang chuẩn bị ảnh...'); const response = await fetch(imageUrlToUse); if (!response.ok) throw new Error('Không thể tải ảnh kết quả.'); const blob = await response.blob(); const file = new File([blob], "processed_image.png", { type: blob.type }); handleFileSelect(file, true); } catch (error) { console.error("Lỗi khi sử dụng ảnh kết quả:", error); alert("Đã xảy ra lỗi khi tải lại ảnh đã xử lý."); } finally { setUiLoading(false); } });
        downloadBtn.addEventListener('click', async () => { const imageUrlToDownload = (resultImage.src && !resultImage.src.startsWith('https://placehold.co')) ? resultImage.src : (originalImageDisplay.src && !originalImageDisplay.src.startsWith('blob:') && !originalImageDisplay.src.startsWith('https://placehold.co')) ? originalImageDisplay.src : null; if (!imageUrlToDownload) { alert("Không có ảnh kết quả để tải xuống."); return; } try { const response = await fetch(imageUrlToDownload); if (!response.ok) throw new Error('Không thể fetch ảnh để tải xuống.'); const blob = await response.blob(); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = \`runninghub_ai_\${Date.now()}.png\`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); } catch (error) { console.error("Lỗi tải xuống:", error); alert("Tải xuống thất bại."); } });

        function saveImageToHistory(url) {
            if (!url || imageHistory.includes(url)) return;
            imageHistory.unshift(url);
            if (imageHistory.length > 51) imageHistory.pop();
            localStorage.setItem('aiImageHistory', JSON.stringify(imageHistory));
        }
        function loadImageHistory() {
            const storedHistory = localStorage.getItem('aiImageHistory');
            if (storedHistory) imageHistory = JSON.parse(storedHistory);
        }
        function displayHistory() {
            historyGrid.innerHTML = '';
            if (imageHistory.length === 0) { historyGrid.innerHTML = '<p class="col-span-3 text-center text-gray-500">Chưa có ảnh nào được tạo.</p>'; return; }
            imageHistory.forEach(url => { const link = document.createElement('a'); link.href = url; link.target = '_blank'; link.rel = 'noopener noreferrer'; const img = document.createElement('img'); img.src = url; img.className = 'w-full h-full object-cover rounded-md cursor-pointer hover:opacity-80 transition-opacity'; img.loading = 'lazy'; link.appendChild(img); historyGrid.appendChild(link); });
        }
        navHistory.addEventListener('click', () => { displayHistory(); historyModal.classList.remove('hidden'); setTimeout(() => { historyPanel.classList.remove('translate-x-full'); }, 10); });
        function closeHistory() { historyPanel.classList.add('translate-x-full'); setTimeout(() => { historyModal.classList.add('hidden'); }, 300); }
        closeHistoryBtn.addEventListener('click', closeHistory);
        historyModal.addEventListener('click', (e) => { if (e.target === historyModal) closeHistory(); });
        
        // Add touch support for hover buttons on images
        document.body.addEventListener('touchstart', function(){
            document.body.classList.add('touch');
        }, { once: true });


        // --- INITIAL UI SETUP ---
        switchView('qwen');
        loadImageHistory();
    <\/script>
</body>
</html>
`;


const translations = {
    // HTML Lang attribute
    '<html lang="vi">': '<html lang="en">',
    // Nav icon alt text
    'alt="Nâng Cao"': 'alt="Advanced"',
    'alt="Cơ Bản"': 'alt="Basic"',
    'alt="Lịch Sử"': 'alt="History"',
    // Qwen controls
    '>Khung hình<': '>Aspect Ratio<',
    '>Giữ bố cục và đối tượng<': '>Keep layout and objects<',
    '>Ảnh tham chiếu<': '>Reference Image<',
    '>Nhấn, kéo thả hoặc dán ảnh<': '>Click, drag & drop, or paste image<',
    'alt="Minh họa Qwen"': 'alt="Qwen Illustration"',
    // Basic controls
    '>Chức năng<': '>Function<',
    '>Tách nền<': '>Remove Background<',
    '>Tách nền lấy mask<': '>Remove BG (get mask)<',
    '>Tăng độ phân giải<': '>Upscale<',
    '>Mức độ<': '>Level<',
    // Advanced controls
    '>Flux Upscale<': '>Flux Upscale<', // already in English
    '>Thay nền<': '>Change Background<',
    '>Khôi phục ảnh củ<': '>Old Photo Restoration<',
    '>Làm nét ảnh mờ (deblur)<': '>Deblur Image<',
    '>Tạo ảnh thẻ<': '>ID Photo Creator<',
    '>Thay thế khuôn mặt<': '>Face Swap<',
    '>E-commerce<': '>E-commerce<', // already in English
    '>Xóa vật theo yêu cầu<': '>Object Remove (by prompt)<',
    '>Xóa mụn, mịn da<': '>Acne Removal, Skin Smoothing<',
    '>Chỉnh ảnh (trang điểm, làm sáng)<': '>Photo Retouch (makeup, lighting)<',
    '>Hòa trộn đồng bộ ánh sáng<': '>Light Harmonization<',
    '>Light and Shadow<': '>Light and Shadow<', // already in English
    '>Phục hồi sản phẩm<': '>Product Restoration<',
    '>Thay trang phục<': '>Change Clothes<',
    '>Tách trang phục<': '>Extract Clothes<',
    '>Trích xuất hình ảnh<': '>Image Extraction<',
    // START NEW TRANSLATION
    '>Render kiến trúc<': '>Architectural Render<',
    // END NEW TRANSLATION
    '>Phong cách ảnh vector<': '>Vector Style<',
    '>Ảnh hoạt hình Ghibli<': '>Ghibli Anime Style<',
    '>Ảnh 3D chibi<': '>3D Chibi Style<',
    '>Ảnh màu nước<': '>Watercolor Style<',
    '>Ảnh vẽ tay (phong cách Trung Hoa)<': '>Chinese Ink Wash Style<',
    '>Tranh biến họa (bút chì)<': '>Pencil Sketch<',
    '>Ảnh phát thảo ánh sáng<': '>Light Sketch<',
    '>Fridge Magnets Style<': '>Fridge Magnets Style<', // already in English
    'alt="Minh họa chức năng"': 'alt="Function Illustration"',
    // Flux upscale controls
    '>Mô hình<': '>Model<',
    '>RealESRGAN:</span> thời gian tạo ảnh nhanh nhưng không giữ được nét mặt.<': '>RealESRGAN:</span> Fast generation, but may not preserve facial details.<',
    '>SeedVR2:</span> tạo ảnh chuyên sâu, kết quả tốt hơn và khuôn mặt có độ giống cao hơn nhưng thời gian tạo ảnh lâu.<': '>SeedVR2:</span> Slower, more detailed generation with better facial similarity.<',
    '>Gợi ý:</span> Nếu ảnh quá mờ hoặc có người thì dùng SeedVR2, còn ảnh thông thường dùng RealESRGAN để tạo ảnh nhanh hơn.<': '>Suggestion:</span> Use SeedVR2 for blurry photos or portraits. Use RealESRGAN for general images to get faster results.<',
    // E-commerce controls
    '>Hiệu ứng<': '>Effect<',
    'alt="Bóng đổ"': 'alt="Shadow"',
    '>Bóng đổ<': '>Shadow<',
    'alt="Hiệu ứng gương"': 'alt="Mirror Effect"',
    '>Hiệu ứng gương<': '>Mirror Effect<',
    // Specific controls
    '>Background tham chiếu<': '>Reference Background<',
    '>Ít tác động<': '>Less Impact<',
    '>Tác động mạnh<': '>Strong Effect<',
    '>Ảnh trang phục<': '>Clothing Image<',
    '>Khuôn mặt cần thay thế<': '>Face to Swap<',
    // Main Panel
    'alt="Vùng hiển thị kết quả"': 'alt="Result display area"',
    'alt="Ảnh gốc"': 'alt="Original Image"',
    'alt="Ảnh kết quả"': 'alt="Result Image"',
    '>Sử dụng ảnh gốc<': '>Use Original<',
    '>Sử dụng ảnh<': '>Use Result<',
    '>Tải xuống<': '>Download<',
    'alt="Đang xử lý..."': 'alt="Processing..."',
    'title="Hủy tác vụ"': 'title="Cancel Task"',
    'placeholder="Nhập prompt của bạn..."': 'placeholder="Enter your prompt..."',
    // Preview modal
    'alt="Ảnh gốc xem trước"': 'alt="Original Image Preview"',
    'alt="Ảnh kết quả xem trước"': 'alt="Result Image Preview"',
    // History panel
    '>Lịch sử ảnh<': '>Image History<',
    // JS strings
    'Lỗi HTTP:': 'HTTP Error:',
    'Tải ảnh lên RunningHub thất bại:': 'Failed to upload to RunningHub:',
    'API tải ảnh lên báo lỗi:': 'Upload API returned an error:',
    'Không nhận được đường dẫn file': 'Did not receive file path',
    'Chức năng này yêu cầu cả ảnh chính và ảnh tham chiếu!': 'This function requires both a main image and a reference image!',
    'Chức năng này yêu cầu phải có ảnh!': 'This function requires an image!',
    'Chức năng "Giữ bố cục" yêu cầu cả ảnh và prompt!': 'The "Keep Layout" function requires both an image and a prompt!',
    'Vui lòng nhập prompt hoặc tải ảnh lên!': 'Please enter a prompt or upload an image!',
    'Chức năng này yêu cầu ảnh khuôn mặt cần thay thế!': 'This function requires an image of the face to swap!',
    'Đang tải ảnh lên...': 'Uploading image...',
    'Đang khởi tạo tác vụ...': 'Initializing task...',
    'Lỗi khi chạy tác vụ:': 'Error running task:',
    'API không khởi động được tác vụ:': 'API failed to start task:',
    'Không nhận được Task ID': 'Did not receive Task ID',
    'Đang xử lý...': 'Processing...',
    'Lỗi trong quy trình:': 'Error during process:',
    'Lỗi kiểm tra trạng thái:': 'Error checking status:',
    'Lỗi API trạng thái:': 'Status API error:',
    'Đang xử lý...': 'Processing...',
    'Tác vụ thất bại trên server.': 'Task failed on server.',
    'Trạng thái:': 'Status:',
    'Không xác định': 'Unknown',
    'Lỗi khi kiểm tra trạng thái:': 'Error while checking status:',
    'Lỗi lấy kết quả:': 'Error fetching output:',
    'API báo lỗi:': 'API returned an error:',
    'Lỗi không xác định': 'Unknown error',
    'API không trả về dữ liệu kết quả.': 'API did not return result data.',
    'Không tìm thấy hình ảnh trong kết quả trả về.': 'No image found in the returned result.',
    'Lỗi khi lấy kết quả:': 'Error while fetching result:',
    'API báo lỗi khi hủy tác vụ:': 'API reported an error while cancelling task:',
    'Lỗi khi hủy tác vụ:': 'Error while cancelling task:',
    'Không có ảnh gốc ban đầu để sử dụng.': 'No initial original image to use.',
    'Không có ảnh kết quả để sử dụng.': 'No result image to use.',
    'Đang chuẩn bị ảnh...': 'Preparing image...',
    'Không thể tải ảnh kết quả.': 'Could not load result image.',
    'Đã xảy ra lỗi khi tải lại ảnh đã xử lý.': 'An error occurred while reloading the processed image.',
    'Lỗi khi sử dụng ảnh kết quả:': 'Error while using result image:',
    'Không có ảnh kết quả để tải xuống.': 'No result image to download.',
    'Không thể fetch ảnh để tải xuống.': 'Could not fetch image for download.',
    'Lỗi tải xuống:': 'Download error:',
    'Tải xuống thất bại.': 'Download failed.',
    'Chưa có ảnh nào được tạo.': 'No images created yet.',
    // NodeInfoList descriptions
    'description: "Người mẫu"': 'description: "Model"',
    'description: "Trang phục"': 'description: "Clothing"'
};

document.getElementById('generate-btn').addEventListener('click', () => {
    const apiKey = document.getElementById('api-key').value;
    const language = document.getElementById('language').value;
    const errorMessageEl = document.getElementById('error-message');

    if (!apiKey.trim()) {
        errorMessageEl.textContent = 'Please enter a valid API key.';
        return;
    }
    errorMessageEl.textContent = '';

    let modifiedHtml = baseHtmlTemplate;

    // 1. Replace API Key
    modifiedHtml = modifiedHtml.replace(/"API key"/g, `"${apiKey}"`);

    // 2. Translate if English is selected
    if (language === 'en') {
        // Replace icons
        modifiedHtml = modifiedHtml.replace(
            'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1758007927/nang_cao_k6yhkj.png',
            'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759669895/Improve_nngngo.png'
        );
        modifiedHtml = modifiedHtml.replace(
            'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1758007927/co_ban_hgoegq.png',
            'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759669895/basic_cuql7h.png'
        );
        modifiedHtml = modifiedHtml.replace(
            'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1758007927/lich_su_tkh4qi.png',
            'https://res.cloudinary.com/dzfuqyqoq/image/upload/v1759669895/history_kxirtt.png'
        );

        // Replace all text content
        for (const [vi, en] of Object.entries(translations)) {
             // Use a RegExp with the 'g' flag for global replacement
            const regex = new RegExp(vi.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g');
            modifiedHtml = modifiedHtml.replace(regex, en);
        }
    }

    // 3. Create and trigger download
    const blob = new Blob([modifiedHtml], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ting_rhtool.html';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});

</script>
</body>
</html>
